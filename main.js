(()=>{"use strict";class e{constructor(){if(this.container=null,new.target===e.prototype.constructor)throw new Error("Нельзя использовать вызов new BaseWindowEditor()")}compareToDOM(e){if(!(e instanceof HTMLElement))throw new Error("Container is not HTMLElement");this.container=e}static addTagHTML(e,{className:t="null",type:s="div",append:i=!0}={}){if(!(e instanceof HTMLElement))throw new Error("Assign object is not HTMLElement");const o=document.createElement(s);return"null"!==t&&o.classList.add(t),i?e.append(o):e.prepend(o),o}}function t(e){let t=e;return t<10&&(t=`0${t}`),t}function s(e){const t=e.match(/\bhttps?:\/\/\S+/gi);return null===t?null:t.length}class i extends e{constructor(e,t){super(),this.serverUrl=t,this.input=null,this.widgetField=null,this.statusFavorites=!1,this.scrollPositionDown=!0,this.scrollMoveDown=!0,this.scrollArrayLoad=[],this.inputListeners=[],this.mediaListeners=[],this.inputFileListeners=[],this.submitFileListeners=[],this.clickWidgetListeners=[],this.scrollWidgetListeners=[],this.clickFavoritesListeners=[],this.clickFilesListeners=[],this.clickMenuListeners=[],this.clickEmojiListeners=[],this.compareToDOM(e)}drawWidget(){this.container.insertAdjacentHTML("afterbegin",'<div class="widget"> <div class="widget__content"> <div class="widget__header"> <div class="header__avatar"></div> <div class="header__title">Bot-meneger</div> <div class="header__controll"> <div class="controll__search"></div> <div class="controll__menu"></div> </div> </div> <div class="widget__field"></div> <div class="widget__menu"> <div class="menu__avatar"></div> <div class="menu__controll"> <div class="controll__favorites"> <span class="controll__favorites__context">Избранное</span> </div> <div class="controll__files"> <span class="controll__files__context">Файлы</span> </div> </div> <div class="field__fiels hidden"> <div class="field__fiels__title"> <h4 class="title__fiels">Ваши файлы</h4> </div> <div class="field__fiels__content"> <div class="content__type__all"> <span class="all__fiels fiels__type__all">Всего: 0</span> </div> <div class="content__type__fiels"> <div class="content__type__img img__video"></div> <span class="content__type__text fiels__type__video">Видео: 0</span> </div> <div class="content__type__fiels"> <div class="content__type__img img__audio"></div> <span class="content__type__text fiels__type__audio">Аудио: 0</span> </div> <div class="content__type__fiels"> <div class="content__type__img img__image"></div> <span class="content__type__text fiels__type__image">Изображения: 0</span> </div> <div class="content__type__fiels"> <div class="content__type__img img__files"></div> <span class="content__type__text fiels__type__files">Файлы: 0</span> </div> <div class="content__type__fiels"> <div class="content__type__img img__links"></div> <span class="content__type__text fiels__type__links">Ссылки: 0</span> </div> </div> </div> </div> <div class="widget__footer"> <div class="footer__smiles"></div> <form class="footer__form"> <input class="footer__form__input" type="text" placeholder="Напишите свое сообщение здесь" name="content"> </form> <div class="footer__media"> <form class="form__media__input"> <input type="file" class="field__input" multiple="multiple" name="file"> <div class="media__files"></div> </form> <div class="media__audio"></div> <div class="media__video"></div> </div> </div> </div> </div> '),this.widgetField=this.getWidgetField();const e=this.container.querySelector(".footer__form");this.input=e.firstElementChild,this.input.focus();this.container.querySelector(".controll__menu").addEventListener("click",(e=>this.onClickMenu(e)));this.container.querySelector(".controll__favorites").addEventListener("click",(e=>this.onClickFavorites(e)));this.container.querySelector(".controll__files").addEventListener("click",(e=>this.onClickFiles(e)));const t=this.container.querySelector(".field__input");t.addEventListener("change",(e=>this.onChangeInput(e)));this.container.querySelector(".media__files").addEventListener("click",(()=>t.click()));this.getformInputFile().addEventListener("submit",(e=>this.onSubmitFileForm(e)));const s=this.container.querySelector(".media__video"),i=this.container.querySelector(".media__audio");s.addEventListener("click",(e=>this.onPressMedia(e))),i.addEventListener("click",(e=>this.onPressMedia(e))),e.addEventListener("submit",(e=>this.onPressInput(e))),this.widgetField.addEventListener("click",(e=>this.onClickWidget(e))),this.widgetField.addEventListener("scroll",(e=>this.onScrollWidget(e)));this.container.querySelector(".footer__smiles").addEventListener("click",(e=>this.onPressEmoji(e)))}getFieldFiles(){return this.container.querySelector(".field__fiels")}getTypeFiles(e){return this.container.querySelector(`.fiels__type__${e}`)}getDivFavorites(){return this.container.querySelector(".controll__favorites")}static findID(e){return document.getElementById(e)}getformInputFile(){return this.container.querySelector(".form__media__input")}getWidgetField(){return this.container.querySelector(".widget__field")}static getSpanTag(){return'<span class="message__text"></span>'}static getVideoTag(){return'<video class="message__video" controls="controls" preload="none"></video>'}static getAudioTag(){return'<audio class="message__audio" controls="controls" preload="none"></audio>'}static getImgTag(){return'<img src="" alt="Изображение" class="message__image">'}static getItemStar(e){return e.querySelector(".message__controll__star")}static getFileDiv(){return'\n      <div class="message__file"></div>\n      <span class="message__file__title"></span>\n    '}static getLinkDownload(e){return`<div class="message__controll__download" data-name=${e}></div>`}static changeFavorite({id:e,favorite:t}={}){const s=i.findID(e),o=i.getItemStar(s);t?o.classList.add("active"):o.classList.remove("active")}static deleteMessage({id:e}={}){i.findID(e).remove()}scrollPage(){this.scrollPositionDown&&(this.widgetField.scrollTop=this.widgetField.scrollHeight)}drawMessage({cords:e,content:s,id:o,timestamp:n,type:r,favorite:a,append:l=!0}={}){const d=i.addTagHTML(this.widgetField,{className:"widget__field__message",append:l});if(d.setAttribute("id",o),d.insertAdjacentHTML("afterbegin",'<div class="message__controll"> <div class="message__controll__star"></div> <div class="message__controll__pen"></div> <div class="message__controll__delete"></div> </div> <div class="message__content"></div> <div class="message__info"> <div class="message__coords"> <span class="coords"></span> <a href="#" class="coords__link" target="_blank"></a> </div> <span class="message__time"></span> </div>'),a){i.getItemStar(d).classList.add("active")}const c=d.querySelector(".message__content");let h=null;if("message"===r)h=i.getSpanTag(),c.innerHTML=h,c.firstChild.innerHTML=s.replace(/\bhttps?:\/\/\S+/gi,(e=>`<a href="${e}" target="_blank">${e}</a>`));else{const e=i.getLinkDownload(s.name);d.querySelector(".message__controll__star").insertAdjacentHTML("afterend",e),"video"===r?h=i.getVideoTag():"audio"===r?h=i.getAudioTag():"image"===r?(h=i.getImgTag(),this.scrollArrayLoad.push(!0)):h=i.getFileDiv(),c.innerHTML=h;["audio","video","image"].includes(r)?(c.firstChild.src=`${this.serverUrl}${s.path}`,c.firstChild.addEventListener("load",(()=>{setTimeout((()=>{this.scrollArrayLoad.pop(),0===this.scrollArrayLoad.length&&(this.scrollMoveDown=!0)}),0),this.scrollPage()}))):c.lastElementChild.textContent=s.originalName}d.querySelector(".message__time").textContent=function(e){const s=new Date(e),i=String(s.getFullYear()),o=t(s.getMonth()+1),n=t(s.getDate());return`${t(s.getHours())}:${t(s.getMinutes())} ${n}.${o}.${i}`}(n);d.querySelector(".coords").textContent=`[${e}]`;const u=d.querySelector(".coords__link"),_=e.replace(" ","");u.setAttribute("href",`http://www.google.com/maps/place/${_}`),this.scrollPage()}resetFavorites(){this.statusFavorites=!1;const e=this.getDivFavorites();e.classList.remove("favorites__active"),e.firstElementChild.textContent="Избранное"}onPressInput(e){e.preventDefault(),this.input.value.length>0&&this.inputListeners.forEach((e=>e.call(null)))}addInputListeners(e){this.inputListeners.push(e)}onPressMedia(e){this.mediaListeners.forEach((t=>t.call(null,e)))}addMediaListeners(e){this.mediaListeners.push(e)}onChangeInput(e){this.inputFileListeners.forEach((t=>t.call(null,e)))}addInputFileListeners(e){this.inputFileListeners.push(e)}onSubmitFileForm(e){this.submitFileListeners.forEach((t=>t.call(null,e)))}addSubmitFileListeners(e){this.submitFileListeners.push(e)}onClickWidget(e){this.clickWidgetListeners.forEach((t=>t.call(null,e)))}addClickWidgetListeners(e){this.clickWidgetListeners.push(e)}onScrollWidget(e){this.scrollWidgetListeners.forEach((t=>t.call(null,e)))}addScrollWidgetListeners(e){this.scrollWidgetListeners.push(e)}onClickFavorites(e){this.clickFavoritesListeners.forEach((t=>t.call(null,e)))}addClickFavoritesListeners(e){this.clickFavoritesListeners.push(e)}onClickFiles(e){this.clickFilesListeners.forEach((t=>t.call(null,e)))}addClickFilesListeners(e){this.clickFilesListeners.push(e)}onClickMenu(e){this.clickMenuListeners.forEach((t=>t.call(null,e)))}addClickMenuListeners(e){this.clickMenuListeners.push(e)}onPressEmoji(e){this.clickEmojiListeners.forEach((t=>t.call(null,e)))}addEmojiListeners(e){this.clickEmojiListeners.push(e)}}class o{constructor(e){if(this.container=null,this.typeModal=e,new.target===o.prototype.constructor)throw new Error("Нельзя использовать вызов new Modal()")}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("Container is not HTMLElement");this.container=e}show(){this.container.classList.remove("hidden")}hide(){this.container.classList.add("hidden"),this.getForm().reset()}getForm(){return document.querySelector(`form[data-type=${this.typeModal}]`)}}class n extends o{constructor(){super("geoModal"),this.submitListeners=[],this.input=null,this.bufferCords=null,this.init()}init(){const e=document.createElement("div");e.setAttribute("class","background__popup"),e.dataset.type="background__geoModal",e.classList.add("hidden"),e.insertAdjacentHTML("afterbegin",'<form class="popup popup__geolocation" data-type="geoModal"> <div class="popup__message"> <p class="popup__body">Что-то пошло не так</p> <p class="popup__body">К сожалению, нам не удалось определить Ваше местонахождение, пожалуйста, дайте разрешение на использование геолокации, либо введите координаты вручную.</p> <p class="popup__body">Широта и долгота через запятую:</p> </div> <input type="text" class="popup__input" required="" placeholder="Пример: [51.50851, -0.12572]"> <div class="popup__control popup__control__geo"> <button class="popup__btn btn__cancel geo__btn__cancel" type="button">Отмена</button> <button class="popup__btn btn__ok geo__btn__ok" type="submit">Ок</button> </div> </form> '),this.bindToDOM(e)}drawModal(e){e.append(this.container),this.input=this.container.querySelector(".popup__input");const t=this.container.querySelector(".btn__cancel"),s=this.container.querySelector(".btn__ok");t.addEventListener("click",(()=>this.hide())),s.addEventListener("click",(e=>this.onSubmit(e))),this.input.addEventListener("input",(()=>this.input.setCustomValidity("")))}show(){super.show(),this.input.focus(),this.bufferCords&&(this.input.value=this.bufferCords)}onSubmit(e){this.submitListeners.forEach((t=>t.call(null,e)))}addGeoModalListeners(e){this.submitListeners.push(e)}}function r(e,t){const s=String(e.latitude).split(".");let i=null;i=s.length>1?s[1].length<t?e.latitude.toFixed(s[1].length):e.latitude.toFixed(t):e.latitude;const o=String(e.longitude).split(".");let n=null;return n=o.length>1?o[1].length<t?e.longitude.toFixed(o[1].length):e.longitude.toFixed(t):e.longitude,`${i}, ${n}`}function a(){return new Promise((e=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((t=>{console.log("data",t),e({latitude:t.coords.latitude,longitude:t.coords.longitude})}),(t=>{console.log("Ошибка получения координат",t),e(!1)}),{timeout:3e3}):e(!1)}))}class l extends o{constructor(){super("recordModal"),this.submitListeners=[],this.media=null,this.timer=null,this.recorder=null,this.stream=null,this.timerId=null,this.chunks=[],this.save=!1,this.urlServer=null,this.time={hours:0,minutes:0,seconds:0},this.init()}init(){const e=document.createElement("div");e.setAttribute("class","background-popup"),e.dataset.type="background-recordModal",e.classList.add("hidden"),e.insertAdjacentHTML("afterbegin",'<form class="popup popup__record" data-type="recordModal" enctype="multipart/form-data"> <div class="popup__title">Запись медиа-контента</div> <p class="popup__title__context"> Записываю ... </p> <div class="popup__media__box"></div> <div class="popup__control popup__control__record"> <button class="popup__btn btn__ok record__btn__ok noactive" type="submit">OK</button> <span class="timer">00:00</span> <button class="popup__btn btn__cancel record__btn__cancel" type="button">Отмена</button> </div> </form>'),this.bindToDOM(e)}static getTagVideo(){return'<video class="video__box" autoplay="" muted name="file"></video>'}static getTagAudio(){return'<audio class="audio__box" autoplay="" muted name="file"></audio>'}getBtnOk(){return this.container.querySelector(".record__btn__ok")}drawModal(e){e.append(this.container),this.timer=this.container.querySelector(".timer");this.container.querySelector(".record__btn__cancel").addEventListener("click",(()=>this.clearData())),this.getForm().addEventListener("submit",(e=>this.onSubmit(e)))}addTagMedia(e){const t=document.querySelector(".popup__media__box");t.innerHTML="video"===e?l.getTagVideo():l.getTagAudio(),this.media=t.firstChild,"audio"===e&&t.classList.add("media__box__background"),this.media.addEventListener("canplay",(()=>{console.log("Подключен медиа поток"),this.recorder.start();this.getBtnOk().classList.remove("noactive")}))}async recordMedia(e,t){const s=t,i=e.video?"video":"audio";try{this.stream=await navigator.mediaDevices.getUserMedia(e)}catch(e){return this.hide(),s.modalError.showError(i),void s.modalError.show()}this.addTagMedia(i),this.media.srcObject=this.stream,this.recorder=new MediaRecorder(this.stream),this.recorder.addEventListener("start",(()=>{this.timerId=setTimeout(this.secundomer.bind(this),1e3)})),this.recorder.addEventListener("dataavailable",(e=>{this.chunks.push(e.data)})),this.recorder.addEventListener("stop",(async()=>{if(this.save){const e="audio"===i?"audio/wav":"video/webm",t=new Blob(this.chunks,{type:e}),o="video"===i?"record.webm":"audio.wav",n=new FormData;n.append("file",t,o);const l=await a();if(!l)return s.buffer.formData=n,this.clearData(),void s.modalCords.show();const d=r(l,5);n.append("cords",d),await fetch(`${this.urlServer}/upload`,{method:"POST",body:n}),this.clearData()}}))}secundomer(){this.time.seconds+=1,60===this.time.seconds&&(this.time.minutes+=1,this.time.seconds=0,60===this.time.minutes&&(this.time.hours+=1,this.time.minutes=0));const e=l.getStringNumber(this.time.seconds),t=l.getStringNumber(this.time.minutes),s=l.getStringNumber(this.time.hours);0===this.time.hours?this.timer.textContent=`${t}.${e}`:this.timer.textContent=`${s}.${t}.${e}`,this.timerId=setTimeout(this.secundomer.bind(this),1e3)}static getStringNumber(e){let t=String(e);return t.length<2&&(t=`0${e}`),t}clearData(){this.stream.getTracks().forEach((e=>{e.stop()})),this.chunks=[],this.save=!1,this.timer.textContent="00.00",clearTimeout(this.timerId),this.time={hours:0,minutes:0,seconds:0};document.querySelector(".popup__media__box").classList.remove("media__box__background"),this.media.remove();this.getBtnOk().classList.add("noactive"),this.hide(),console.log("Данные очищены")}onSubmit(e){e.preventDefault(),this.submitListeners.forEach((t=>t.call(null,e)))}addRecordListeners(e){this.submitListeners.push(e)}}class d extends o{constructor(){super("errorModal"),this.box=null,this.init()}init(){const e=document.createElement("div");e.setAttribute("class","background-popup"),e.dataset.type="background-errorModal",e.classList.add("hidden"),e.insertAdjacentHTML("afterbegin",'<form class="popup popup__error" data-type="errorModal"> <div class="popup__title"> <h3 class="title__error">Ошибка медиа-устройств</h3> </div> <div class="popup__content content__error"> <div class="content__error__audio hidden"> <span class="content__text">У Вас нет разрешения на использование микрофона.</span> <span class="content__text">Подключите микрофон и попробуйте заново.</span> </div> <div class="content__error__video hidden"> <span class="content__text">У Вас нет разрешения на использование</span> <span class="content__text">вебкамеры или микрофона.</span> <span class="content__text">Подключите устройства и попробуйте заново.</span> </div> </div> <div class="popup__control control__btn__ok"> <button class="popup__btn btn__ok error__btn__ok" type="button">Ok</button> </div> </form>'),this.bindToDOM(e)}drawModal(e){e.append(this.container);this.container.querySelector(".error__btn__ok").addEventListener("click",(()=>this.clearModal()))}getSelector(e){return this.container.querySelector(e)}showError(e){this.box=this.container.querySelector(`.content__error__${e}`),this.box.classList.remove("hidden")}clearModal(){this.box.classList.add("hidden"),this.hide(),this.box=null}}const c=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","😢","😭","😤","😠","😡","🤬","🥵","🤯","😳","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😬","🙄","😯","😧","😮","😲","😴","🤤","😪","😵","🤐","🤢","🤮","🤧","😷","🤒","😦","🤕","🤑","🤠","😈","👿","👹","👺","🤡","💀","☠️","👽","🎃","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🤲","👐","🙌","👏","🤝","👍","👎","👊","✊","🤛","🤜","🤞","✌️","🤟","🤘","👌","👈","👉","👆","👇","☝️","✋","🤚","🖐","🖖","👋","🤙","💪","🖕","✍️","🙏","💋","👅","🍁","🍄","🌾","💐","🌷","🌹","🥀","🌺","🌸","🌼","🌻","🌞","🏆","🥇","🥈","🥉","🏅","❤️","💛","💚","👄","💙","💜","🖤","💔","❣️","💕","💞","💓","💖","💘","💝","🌳","🌲","🙈","🙉","🙊","🥂","🚀","💥","👻"];class h{constructor(e,t){this.edit=e,this.url=t,this.buffer={},this.generator=null,this.arrayMessage=null,this.allMessage=null,this.step=0,this.ws=new WebSocket(t.replace(/^http/,"ws"))}init(){this.edit.drawWidget(),this.edit.addInputListeners(this.onPressInput.bind(this)),this.edit.addMediaListeners(this.onPressMedia.bind(this)),this.edit.addInputFileListeners(this.onChangeInput.bind(this)),this.edit.addSubmitFileListeners(this.onSubmitFileForm.bind(this)),this.edit.addClickWidgetListeners(this.onClickWidget.bind(this)),this.edit.addScrollWidgetListeners(this.onScrollWidget.bind(this)),this.edit.addClickFavoritesListeners(this.onClickFavorites.bind(this)),this.edit.addClickFilesListeners(this.onClickFiles.bind(this)),this.edit.addClickMenuListeners(this.onClickMenu.bind(this)),this.edit.addEmojiListeners(this.onPressEmoji.bind(this)),this.getForms(),this.addListenersForms(),this.addListenersWS(),this.edit.widgetField.addEventListener("dragover",(e=>e.preventDefault())),this.edit.widgetField.addEventListener("drop",(e=>{e.preventDefault();const{files:t}=e.dataTransfer;t&&this.dropFiles(t)})),setInterval((()=>{this.ws.send(JSON.stringify({echo:!0}))}),3e3)}getForms(){this.modals={geoModal:new n,errorModal:new d,recordModal:new l};const e=this.edit.container.querySelector(".widget");this.modals.geoModal.drawModal(e),this.modals.recordModal.drawModal(e),this.modals.errorModal.drawModal(e)}getModal(e){return this.modals[e]}addListenersForms(){this.getModal("geoModal").addGeoModalListeners(this.submitGeoModal.bind(this));this.getModal("recordModal").addRecordListeners(this.submitRecordModal.bind(this))}addListenersWS(e="ws open"){this.ws.addEventListener("open",(()=>console.log(e))),this.ws.addEventListener("close",(()=>{console.log("ws close"),setTimeout((()=>this.recoveryConnectWS()),5e3)})),this.ws.addEventListener("error",(()=>{console.log("ws error")})),this.ws.addEventListener("message",(async e=>{const t=await JSON.parse(e.data);if("connection"!==t.status)if("echo"===t.status&&console.log("Связь с сервером в наличии"),"changeFavorite"!==t.status)if("deleteMessage"!==t.status){if(!this.edit.statusFavorites)for(let e=0;e<t.length;e+=1)if(this.edit.drawMessage(t[e]),"message"===t[e].type){const i=s(t[e].content);i>0&&(this.replaceCount("links",i),this.replaceCount("all",i))}else this.replaceCount(t[e].type,1),this.replaceCount("all",1)}else{const e=this.allMessage.findIndex((e=>e.id===t.result.id));this.allMessage.splice(e,1);if(this.edit.constructor.findID(t.result.id))if(this.edit.constructor.deleteMessage(t.result),"message"===t.result.type){const e=s(t.result.content);e>0&&(this.replaceCount("links",-e),this.replaceCount("all",-e))}else this.replaceCount(t.result.type,-1),this.replaceCount("all",-1);if(this.edit.widgetField.scrollHeight===this.edit.widgetField.clientHeight){const e=this.generator.next().value;if(e){e.reverse();for(let t=0;t<e.length;t+=1){this.edit.constructor.findID(e[t].id)||(e[t].append=!1,this.edit.drawMessage(e[t]))}}}}else if(this.edit.statusFavorites&&t.result.favorite){const e=await this.request({path:`getMessage/${t.result.id}`,method:"GET"}),s=await e.json();this.edit.drawMessage(s)}else if(this.edit.statusFavorites&&!t.result.favorite)this.edit.constructor.deleteMessage(t.result);else{if(this.edit.constructor.findID(t.result.id))this.edit.constructor.changeFavorite(t.result);else{const e=this.allMessage.findIndex((e=>e.id===t.result.id));this.allMessage[e].favorite=t.result.favorite}}else{console.log("Новое подключение к серверу"),this.edit.statusFavorites&&this.edit.resetFavorites(),this.allMessage=t.result.slice(),this.generator=this.generatorMessages(10);const e=this.generator.next().value;for(let t=0;t<e.length;t+=1){this.edit.constructor.findID(e[t].id)||this.edit.drawMessage(e[t])}}}))}recoveryConnectWS(){this.ws=new WebSocket(this.url.replace(/^http/,"ws")),this.addListenersWS("Соединение ws востановлено")}async onPressInput(){const e=await a();if(!e){return void this.getModal("geoModal").show()}const t=r(e,5),s=this.edit.container.querySelector(".footer__form"),i=new FormData(s);i.append("cords",t),i.append("type","message"),this.edit.input.value="",await this.request({path:"message",method:"POST",body:i})}async requestAddMessage(e,t){const s=new FormData;s.append("cords",e),s.append("type","message"),s.append("content",this.edit.input.value),await this.request({path:"message",method:"POST",body:s}),t.hide(),this.edit.input.value=""}async submitGeoModal(e){const t=this.getModal("geoModal"),{input:s}=t;if(s.validity.valueMissing)return void s.setCustomValidity("Укажите широту и долготу согласно образца");const i=function(e){const{value:t}=e;if(/^\[[-+]?\d{1,2}(?:\.\d+)?,\s*[-+]?\d{1,3}(?:\.\d+)?\]$/.test(t)){const[e,s]=t.split(",");return{latitude:Number(e.replace("[","").trim()),longitude:Number(s.replace("]","").trim())}}if(/^[-+]?\d{1,2}(?:\.\d+)?,\s*[-+]?\d{1,3}(?:\.\d+)?$/.test(t)){const[e,s]=t.split(",");return{latitude:Number(e.trim()),longitude:Number(s.trim())}}return e.setCustomValidity("Не верно указаны координаты"),!1}(s);if(!i)return;e.preventDefault();const o=r(i,5);if(t.bufferCords=o,this.buffer.drop){for(const e of this.buffer.drop)e.append("cords",o),this.request({path:"upload",method:"POST",body:e});return t.hide(),void(this.buffer={})}if(this.buffer.formData)return this.buffer.formData.append("cords",o),await this.request({path:"upload",method:"POST",body:this.buffer.formData}),t.hide(),void(this.buffer={});this.requestAddMessage(o,t)}onPressMedia(e){const t={video:e.target.className.includes("video"),audio:!0},s={modalCords:this.getModal("geoModal"),modalError:this.getModal("errorModal"),buffer:this.buffer},i=this.getModal("recordModal");i.show(),i.recordMedia(t,s)}submitRecordModal(){const e=this.getModal("recordModal");e.getBtnOk().className.includes("noactive")||(e.save=!0,e.urlServer=this.url,e.recorder.stop(),this.edit.input.value="")}onChangeInput(e){const{files:t}=e.target;if(!t)return;this.edit.getformInputFile().dispatchEvent(new Event("submit"));e.target.value=""}async onSubmitFileForm(){const e=this.edit.getformInputFile(),t=new FormData(e),s=await a();if(!s){this.buffer.formData=t;return void this.getModal("geoModal").show()}const i=r(s,5);t.append("cords",i),await this.request({path:"upload",method:"POST",body:t})}async dropFiles(e){let t=!1,s=await a();if(!s){const i=this.getModal("geoModal");if(!i.bufferCords){this.buffer.drop=[];for(const t of e){const e=new FormData,{name:s}=t;e.append("file",t,s),this.buffer.drop.push(e)}return void i.show()}s=i.bufferCords,t=!0}const i=t?s:r(s,5);for(const t of e){const e=new FormData,{name:s}=t;e.append("file",t,s),e.append("cords",i),this.request({path:"upload",method:"POST",body:e})}}async onClickWidget(e){const{target:t}=e;if(t.className.includes("message__controll__star")){const e=!t.className.includes("active"),s=t.closest(".widget__field__message");await this.request({path:`favorites/${s.id}`,method:"PATCH",body:JSON.stringify({favorite:e})})}if(t.className.includes("message__controll__delete")){const e=t.closest(".widget__field__message");this.step+=1,await this.request({path:`delete/${e.id}`,method:"DELETE"})}if(t.className.includes("message__controll__download")){const{name:e}=t.dataset,s=await fetch(`${this.url}/loadFile/${e}`),i=await s.blob(),o=URL.createObjectURL(i),n=document.createElement("a");n.href=o,n.setAttribute("download",e),n.click()}}*generatorMessages(e){let t=0,s=[];const i=this.allMessage.length;if(0===i)return this.step=0,s;for(let o=0;o<i;o+=1){const i=this.allMessage.length-1;if(i-o+this.step<0)return this.step=0,s.reverse();t+=1,s.push(this.allMessage[i-o+this.step]),t===e&&(yield s.reverse(),s=[],t=0)}return this.step=0,s.reverse()}onScrollWidget(e){const t=this.edit.widgetField.scrollTop+e.target.clientHeight;if(this.edit.scrollMoveDown&&(t+1>=this.edit.widgetField.scrollHeight||this.edit.scrollArrayLoad.length>0))this.edit.scrollPositionDown=!0;else if(this.edit.scrollPositionDown=!1,0===this.edit.widgetField.scrollTop){this.edit.scrollMoveDown=!1;const e=this.edit.widgetField.scrollHeight,t=this.generator.next();if(t.value){t.value.reverse();for(let s=0;s<t.value.length;s+=1)this.edit.drawMessage({...t.value[s],append:!1}),this.edit.widgetField.scrollTop=this.edit.widgetField.scrollHeight-e}else this.edit.scrollMoveDown=!0}}request({path:e,method:t="GET",body:s=null}={}){return new Promise((i=>{i(fetch(`${this.url}/${e}`,{method:t,body:s}))}))}async onClickFavorites(){const e=this.edit.getDivFavorites();this.edit.scrollPositionDown=!0;let t=null;this.edit.statusFavorites?(this.edit.resetFavorites(),t=await this.request({path:"all"})):(this.edit.statusFavorites=!0,e.classList.add("favorites__active"),e.firstElementChild.textContent="Отменить избранное",t=await this.request({path:"favorites"}));const s=await t.json();this.step=0,this.allMessage=s.slice(),this.generator=this.generatorMessages(10);const{value:i}=this.generator.next();[...this.edit.getWidgetField().children].forEach((e=>e.remove()));for(let e=0;e<i.length;e+=1)this.edit.drawMessage(i[e])}async onClickFiles(){const e=this.edit.container.querySelector(".controll__files"),t=this.edit.getFieldFiles();this.clearFiles(),t.className.includes("hidden")?(t.classList.remove("hidden"),this.countFiles(),e.classList.add("controll__files__active"),e.firstElementChild.textContent="Закрыть файлы"):(t.classList.add("hidden"),e.classList.remove("controll__files__active"),e.firstElementChild.textContent="Файлы")}async countFiles(){const e=await this.request({path:"all"}),t=await e.json();for(let e=0;e<t.length;e+=1){const{type:i}=t[e];if("message"===i){const i=s(t[e].content);i>0&&(this.replaceCount("links",i),this.replaceCount("all",i))}else this.replaceCount(i,1),this.replaceCount("all",1)}}clearFiles(){const e=["all","video","audio","image","files","links"];for(const t of e)this.replaceCount(t,!1)}replaceCount(e,t){const s=this.edit.getTypeFiles(e);if(!s)return;const i=s.textContent.split(": ");i[1]=!1!==t?Number(i[1])+t:0,s.textContent=i.join(": ")}onClickMenu(){const e=this.edit.container.querySelector(".widget__menu"),t=this.edit.container.querySelector(".widget__field"),s=this.edit.container.querySelector(".controll__menu");if(e.className.includes("widget__menu__active")){e.classList.remove("widget__menu__active"),t.classList.remove("widget__field__mini"),s.classList.remove("controll__menu__active"),this.clearFiles();this.edit.container.querySelector(".field__fiels").classList.add("hidden");const i=this.edit.container.querySelector(".controll__files");i.className.includes("controll__files__active")&&(i.classList.remove("controll__files__active"),i.firstElementChild.textContent="Файлы")}else e.classList.add("widget__menu__active"),t.classList.add("widget__field__mini"),s.classList.add("controll__menu__active")}onPressEmoji(e){const{target:t}=e;if(t.className.includes("footer__smiles")){const e=t.querySelector(".box__smiles__conteiner");if(e)t.classList.remove("footer__smiles__active"),e.remove();else{t.classList.add("footer__smiles__active");const e=this.edit.constructor.addTagHTML(t,{className:"box__smiles__conteiner"}),s=this.edit.constructor.addTagHTML(e,{className:"box__smiles"});c.forEach((e=>{this.edit.constructor.addTagHTML(s,{className:"smile__item"}).textContent=e})),e.addEventListener("click",(e=>{e.target.className.includes("smile__item")&&(this.edit.input.value+=e.target.textContent,this.edit.input.focus())}))}}}}const u=document.querySelector(".container"),_=new class{constructor(e,t){this.edit=new i(e,t),this.controller=new h(this.edit,t)}init(){this.controller.init()}}(u,"https://javascript-26-coursework-backend.onrender.com");_.init()})();